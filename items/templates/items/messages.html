{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-[#0f172a] py-12 px-8 text-white">
    <div class="max-w-6xl mx-auto flex h-[600px] bg-[#1e293b] rounded-2xl border border-slate-700 shadow-2xl overflow-hidden">
        
        <!-- Sidebar: List of Conversations -->
        <div class="w-1/3 border-r border-slate-700 bg-[#0f172a]/50">
            <div class="p-6 border-b border-slate-700">
                <h2 class="text-xl font-bold text-blue-500">Messages</h2>
            </div>
            <div class="overflow-y-auto h-full">
                {% for contact in contacts %}
                <a href="{% url 'messages_view' contact.id %}" 
                   class="block p-4 border-b border-slate-700 hover:bg-slate-800 cursor-pointer transition {% if receiver.id == contact.id %}bg-blue-600/10 border-l-4 border-l-blue-500{% endif %}">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm">{{ contact.username }}</span>
                        <span class="text-[10px] text-slate-500">Recent</span>
                    </div>
                    <p class="text-xs text-slate-400 truncate">Click to view conversation</p>
                </a>
                {% empty %}
                <div class="p-10 text-center text-slate-600">
                    <i class="fa-solid fa-comments text-4xl mb-4 opacity-20"></i>
                    <p class="text-sm font-medium mb-2">No conversations yet</p>
                    <p class="text-xs opacity-60 mb-4">Start a conversation by contacting item owners from approved claims</p>
                    <a href="{% url 'claim_history' %}" class="text-blue-400 hover:text-blue-300 text-xs underline">
                        View Your Claims
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col bg-[#1e293b]">
            {% if receiver %}
            <!-- Chat Header: Founder Details -->
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-[#0f172a]/30">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-lg">
                        {{ receiver.username|first|upper }}
                    </div>
                    <div>
                        <p class="font-bold text-blue-400">{{ receiver.username }}</p>
                        <p class="text-[10px] {% if receiver.is_authenticated %}text-green-500{% else %}text-slate-500{% endif %}">
                            {% if receiver.is_active %}Online{% else %}Away{% endif %}
                        </p>
                    </div>
                </div>
                <a href="{% url 'dashboard' %}" class="text-xs text-slate-400 hover:text-white bg-slate-800 px-3 py-1 rounded-md">Close Chat</a>
            </div>

            <!-- Message History Container -->
            <div id="message-container" class="flex-1 p-6 overflow-y-auto space-y-4 bg-slate-900/20">
                {% for msg in chat_messages %}
                    {% if msg.sender == request.user %}
                    <!-- Sent Message (Right) -->
                    <div class="flex flex-col items-end">
                        <div class="bg-blue-600 p-3 rounded-2xl rounded-tr-none max-w-md shadow-md">
                            <p class="text-sm">{{ msg.content }}</p>
                        </div>
                        <span class="text-[8px] text-slate-500 mt-1 uppercase">{{ msg.timestamp|date:"P" }}</span>
                    </div>
                    {% else %}
                    <!-- Received Message (Left) -->
                    <div class="flex flex-col items-start">
                        <div class="bg-[#0f172a] p-3 rounded-2xl rounded-tl-none border border-slate-700 max-w-md shadow-md">
                            <p class="text-sm">{{ msg.content }}</p>
                        </div>
                        <span class="text-[8px] text-slate-500 mt-1 uppercase">{{ msg.timestamp|date:"P" }}</span>
                    </div>
                    {% endif %}
                {% empty %}
                <div class="h-full flex items-center justify-center">
                    <p class="text-slate-500 italic text-sm">Start your conversation with {{ receiver.username }}</p>
                </div>
                {% endfor %}
            </div>

            <!-- Message Input Form -->
            <div class="p-4 bg-[#0f172a]/50 border-t border-slate-700">
                <form method="POST" action="{% url 'messages_view' receiver.id %}" class="flex gap-4">
                    {% csrf_token %}
                    <input type="text" name="content" placeholder="Type your message..." required
                           class="flex-1 bg-[#0f172a] border border-slate-600 rounded-xl px-4 py-3 text-sm text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-xl font-bold text-sm transition-all transform hover:scale-105 active:scale-95 shadow-lg shadow-blue-900/20">
                        Send
                    </button>
                </form>
            </div>
            
            {% else %}
            <!-- State when no contact is selected -->
            <div class="flex-1 flex flex-col items-center justify-center text-slate-500 p-10">
                <i class="fa-solid fa-comments text-5xl mb-4 opacity-20"></i>
                <p class="text-lg font-medium mb-2">Select a contact to start chatting</p>
                <p class="text-sm opacity-60 mb-4">Your conversations will appear here.</p>
                <div class="text-center">
                    <p class="text-xs text-slate-600 mb-2">ðŸ’¡ How to start conversations:</p>
                    <p class="text-xs text-slate-500">1. Submit claims for items</p>
                    <p class="text-xs text-slate-500">2. Wait for admin approval</p>
                    <p class="text-xs text-slate-500">3. Contact item owners from claim history</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Auto-scroll to the bottom of the chat on load
    window.onload = function() {
        var container = document.getElementById('message-container');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    };
</script>
{% endblock %}